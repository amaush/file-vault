var filevault=function(){var e=function(e){filevault.main.initModule(e)};return{initModule:e}}();filevault.data=function(){"use strict";var e,t,n,i={options:{method:"GET",url:"/image",event_name:"",data:""}};return e=function(e){function t(e,t){var n,i,r,d;t=l[t],r=$(e).width(),i=e.find($(".inner-bar").width(0)),n=r/100,d=e.find(".progress"),a=new XMLHttpRequest,o=new FormData,a.onreadystatechange=function(e){return 4==this.readyState&&200==this.status?($(document).trigger({type:"uploadFinished",response:JSON.parse(this.response)}),!0):void 0},a.upload.onprogress=function(e){if(e.lengthComputable){var t=Math.floor(e.loaded/e.total*100);d.text(t+"%"),i.width(t*n)}},a.open("POST","/image"),o.append("ImgFiles",t,t.name),a.send(o)}var n,i,o,a,t,l=e.file_map,r=e.url_list,d=e.$container;r.forEach(function(e,o){n=d.find('img[src="'+e+'"]'),i=n.next(".bar"),t(i,e)})},n=function(e){var t=$.extend({},i.options,e);$.ajax(t).done(function(e){$(document).trigger(t.event_name+"Finished",e)})},t=function(){},{initModule:t,sendFiles:e,get:n}}(),filevault.model=function(){var e,t;return e=function(){var e;return e=function(e){var t=[];return t=e.map(makePhoto)},{add:e}}(),onFilesUpload=function(e,t){console.log("Called onFilesUpload handler"),t.forEach(function(e,t){jqueryMap.$img_box.append(e)})},makePhoto=function(e){var t,n={};return t=Object.create(n),t.name=e.name,t.lastModified=e.lastModified,t.size=e.size,t.type=e.type,t.src=e.src,t},t=function(){},{initModule:t,gallery:e}}(),filevault.model=function(){"use strict";var e,t,n;return e=function(){var e,i,o,a,l,r,d,s={core_html:String()+'<div id="filevault-photos"></div><aside id="filevault-side-bar"></aside>'},c={$container:null},u={};return e=function(){u={$content:c.$container.find("#filevault-photos"),$side_bar:c.$container.find("#filevault-side-bar")}},o=function(e){var t,i,o,l,r,o=e;console.log("path : ",o),r=o.split("/"),r.shift(),i=r.pop(),t="/"+r.join("/"),i=i.replace("_t",""),l=n({image_path:t,image_name:i}),history.pushState({url:"/"+i,path:e},"image",i),u.$content.empty(),u.$content.append(l),a()},a=function(){var e=t.get_thumbnails();e.forEach(function(e){u.$side_bar.append(e)})},d=function(e){e.preventDefault(),o(e.target.getAttribute("src"))},r=function(e){e.preventDefault(),o(e.target.getAttribute("src"))},l=function(e,t){e.preventDefault(),o(t.getAttribute("src"))},i=function(t){c.$container=t,t.append(s.core_html),$(document).on("toggleGallery",l),e(),u.$content.on("click",d),u.$side_bar.on("click",r)},{initModule:i,showPhoto:o}}(),t=function(){var e,t,i,o,a,l,r,d,s={core_html:'<div id="filevault-gallery-container"></div>'},c={$container:null,photo_db:[]},u={};return e=function(){c.$container;u={$container:c.$container,$content:c.$container.find("#filevault-gallery-container")}},d=function(e){var t=e.files||null;t?filevault.data.sendFiles(e):filevault.data.get(e)},o=function(e,t){t||filevault.data.get({event_name:"updateGallery"})},a=function(){return c.photo_db},i=function(e){u.$content.detach(),u.$content.empty(),e?e.forEach(function(e,t){var i=n(e);u.$content.append(i),c.photo_db.push(i)}):(console.log("CACHE HIT"),photo_db.forEach(function(e,t){u.$content.append(e)})),u.$container.append(u.$content)},l=function(e){$(document).trigger("toggleGallery",e.target)},r=function(e,t){var n=t.success,o=t.message;n?i(o):u.$content.html('<div class="error">Message failed with '+o)},t=function(t){c.$container=t,c.$container.html(s.core_html),e(),u.$content.on("click",l),$(document).on("updateGalleryFinished",r),$(document).on("uploadFinished",r)},{initModule:t,updateGallery:o,send:d,get_thumbnails:a}}(),n=function(e){var t,n,i=e;n=i.image_path+"/"+i.image_name;var t=$("<img />");return t.attr({src:n,title:"image","data-lm":"","data-title":"","data-lastM":""}),t},{gallery:t,photo:e}}(),filevault.modal=function(){"use strict";var e,t,n,i,o,a,l,r,d,s,c,u,p,f,g,m,v,_,h={core_html:String()+'<div id="modal-background"></div><div id="modal-content"><div id="filevault-upload-form"><form method="post" class="filevault-upload-form" enctype="multipart/form-data" action="" ><fieldset><input type="file" accept="image/*" name="imgData" multiple="multiple" id="filevault-file-input" style="display:none" ><a href="#" id="filevault-file-picker" class="filevault-button">Click here to browse for file/s </a><div id="filevault-drop-zone"><p>OR</p>Drop files here</div></fieldset></form><div id="filevault-preview-pane"><div id="filevault-upload-button" class="filevault-button"><a href="">Upload your file/s </a></div></div></div><a href="" title="Close" class="close">X</a></div></div>',progress_bar_html:String()+'<div class="bar"><div class="inner-bar"></div><span class="progress"></span></div>',login_html:String()+'<header class="account-header" id="account-header"><span><a href="">Login</a></span><span><a href="">Register</a></span></header><section class="account-form" id="login-account"><form method="" class="minimal" id="login-form"><label for="email">Email: <span id="login-error" class="error" style="display:none"></span><input type="email" name="email" id="login-email" placeholder="Email" required=required /></label><label for="login-password">Password: <input type="password" name="password" id="login-password" placeholder="********" required="required" /></label><span class=""><a href="">Register</a></span><button type="submit" class=""> Sign in</button></form></section>',register_html:String()+'<section class="account-form" id="register-account"><form method="" class="minimal" id="register-form"><label for="register-email">Email: <span id="register-email-error" class="error" style="display:none"></span><input type="email" name="email" id="register-email" placeholder="Email" required=required /></label><label for="register-password">Password: <span id="register-password-error" class="error" style="display:none"></span><input type="password" name="password" id="register-password" placeholder="********" required="required" /><label for="register-password-confirm">Confirm Password : <input type="password" name="password-confirm" id="register-password-confirm" placeholder="********" required="required" /></label><button type="submit" class="btn-minimal">Register</button></form></section>'},b={$container:null,user_files:{},is_upload_modal:!0},y={$login_form:null,$account_header:null,$register_form:null};return i=function(){var e=b.$container.find("#modal-content");y={$container:e,$upload_form:e.find("#filevault-upload-form"),$file_picker:e.find("#filevault-file-picker"),$file_input:e.find("#filevault-file-input"),$preview_pane:e.find("#filevault-preview-pane"),$drop_zone:e.find("#filevault-drop-zone"),$button:e.find("#filevault-upload-button"),$img_collection:$("<div />").attr({"class":"img-container"}),$modal_background:b.$container.find("#modal-background"),$close_modal:b.$container.find(".close")}},e=function(e,t){var n=t?1024:1e3;if(Math.abs(e)<n)return e+" B";var i=t?["KiB","MiB","GiB","TiB","PiB","EiB","ZiB","YiB"]:["kB","MB","GB","TB","PB","EB","ZB","YB"],o=-1;do e/=n,++o;while(Math.abs(e)>=n&&o<i.length-1);return e.toFixed(1)+" "+i[o]},t=function(t){for(var n=/^image\//,i=0;i<t.length;i++){var o=t[i];if(n.test(o.type)){var a=$("<span></span>").attr({"class":"remove-file"}).html('<a href="">X</a>'),l=$("<p></p>").attr({"class":"img-wrapper"}),r=$("<img>").eq(0),d=window.URL.createObjectURL(o);r.attr({src:d,height:60,title:o.name}),r.onload=function(){window.URL.revokeObjectURL(o)},b.user_files[d]=o,l.append(r),l.append(e(o.size)),l.append(h.progress_bar_html),l.append(a),y.$img_collection.append(l)}}y.$preview_pane.append(y.$img_collection)},_=function(e){y.$register_form.detach(),y.$container.append(y.$login_form),e.preventDefault()},c=function(e){var t,n;y.$login_error.text(""),t=y.$login_form.find("input[type=email]"),n=y.$login_form.find("input[type=password]"),t.val()&&n.val()?console.log("email :%s pass: %s ",t.val(),n.val()):y.$login_error.text("Fields cannot be empty"),e.preventDefault()},v=function(e){y.$login_form.detach(),y.$container.append(y.$register_form),e.preventDefault()},p=function(e){e.preventDefault();var t,n,i,o;y.$register_password_error.text(""),y.$register_email_error.text(""),o=y.$register_form.find("input[type=email]"),console.log(o.val()),t=y.$register_form.find("input[type=password]"),n=t.eq(0),i=t.eq(1),n.val()===i.val()?console.log("passwords match!"):(y.$register_password_error.text("Passwords are not matching"),y.$register_password_error.show())},d=function(e){e.preventDefault(),y.$upload_form.detach(),b.is_upload_modal=!1,y.$container.html(h.login_html+h.register_html),y.$account_header=y.$container.find("#account-header"),y.$login_form=y.$container.find("#login-account"),y.$login_password_error=y.$login_form.find("#login-password-error"),y.$login_error=y.$login_form.find("#login-email-error"),y.$login_button=y.$login_form.find("button"),y.$register_form=y.$container.find("#register-account"),y.$register_password_error=y.$register_form.find("#register-password-error"),y.$register_email_error=y.$register_form.find("#register-email-error"),y.$register_button=y.$register_form.find("button"),y.$register_form.detach(),y.$login_button.on("click",c),y.$register_button.on("click",p),y.$account_header.on("click",function(e){e.preventDefault();var t="Login"===e.target.textContent?_:v;t(e)})},s=function(e){e.preventDefault(),b.is_upload_modal||(y.$container.empty(),y.$container.append(y.$upload_form),b.is_upload_modal=!0)},u=function(){alert("Logged Out")},m=function(e){y.$file_input.click(),e.preventDefault()},f=function(e){var n=e.target.files;y.$preview_pane.show(),t(n)},o=function(e){e.isPropagationStopped?console.log("Drop Propagation Stopped"):console.log("Drop Propagation not Stopped"),files=e.dataTransfer.files,y.$preview_pane.show(),t(files),e.preventDefault(),e.stopPropagation()},a=function(e){e.stopPropagation(),e.preventDefault(),e.dataTransfer.dropEffect="copy"},l=function(e){e.isPropagationStopped?console.log("Dragover Propagation Stopped"):console.log(" DragOver Propagation not Stopped")},r=function(e){var t,n,i,o,a=$(e.target);e.preventDefault(),e.stopPropagation(),a.is("a")?(t=a.closest("p.img-wrapper"),n=a.closest("p").find("img")[0],console.log(n),t.siblings("p").length?(t.remove(),delete b.user_files[n.src]):(t.remove(),b.user_files={},y.$preview_pane.hide())):a.is(y.$button)&&(i=Object.keys(b.user_files),o=filevault.model.gallery.send({file_map:b.user_files,url_list:i,$container:y.$preview_pane,files:!0}),o&&console.log("request successful"))},g=function(e){$(document).trigger("toggleModal"),e.preventDefault()},n=function(e){$.event.props.push("dataTransfer"),b.$container=e,e.append(h.core_html),i(),y.$modal_background.on("click",g),y.$preview_pane.hide(),y.$file_picker.on("click",m),y.$file_input.on("change",f),y.$drop_zone.on("dragenter",a),y.$drop_zone.on("dragover",l),y.$drop_zone.on("drop",o),y.$preview_pane.on("click",r),y.$close_modal.on("click",function(e){e.preventDefault(),$(document).trigger("toggleModal")}),$(document).on("loginClick",d),$(document).on("uploadClick",s),$(document).on("signout",u)},{initModule:n}}(),filevault.main=function(){"use strict";var e,t,n,i,o,a,l,r,d,s,c,u={core_html:String()+'<div id="filevault-main-content"><div class="filevault-head"><div id="filevault-logo"><h1><a href="">FileVault</a></h1></div><div id="filevault-global-button" class="filevault-button"><a href="">Upload File/s</a></div><div id="filevault-acct" class="filevault-button"><a href="">Sign In</a> / <a href="">Register</a></div></div><div id="filevault-content"><div id="filevault-upload-modal" style = display: none;></div><div id="filevault-gallery-collection"></div><div id="filevault-gallery"></div><div id="filevault-gallery-photo"></div></div></div>'},p={is_upload:!0,base_url:"/image",is_gallery_visible:!0},f={};return e=function(){var e=p.$container;f={$container:e,$content:e.find("#filevault-content"),$acct:e.find("#filevault-acct"),$upload_modal:e.find("#filevault-upload-modal"),$global_upload_button:e.find("#filevault-global-button"),$gallery_container:e.find("#filevault-gallery"),$photo_container:e.find("#filevault-gallery-photo"),$side_bar:e.find("#filevault-side-bar")}},l=function(e){e.preventDefault(),i(),$(document).trigger("loginClick")},a=function(e){e.preventDefault(),i(),$(document).trigger("uploadClick")},d=function(e){e.preventDefault(),i()},i=function(){f.$upload_modal.toggle()},s=function(){console.log("toggling State"),p.is_gallery_visible?(f.$photo_container.toggle,p.is_gallery_visible=!1):(f.$gallery_container.toggle(),p.is_gallery_visible=!0)},r=function(e){console.log("upload finished evt"),i()},n=function(){console.log("toggling gallery"),f.$gallery_container.toggle()},c=function(e){return history.state?(console.log("back button: ",history.state.url,history.state.path),void o.navigate(history.state.url,history.state.path)):(history.replaceState(null,null,location.pathname),console.log("navigating location.pathname : %s ",location.pathname),o.navigate(location.pathname),!0)},o=function(e){var t,n,i=({"/":filevault.model.gallery.updateGallery},[{"/^/[^w|S]/":filevault.gallery.updateGallery}]);return t=function(e,t){i.push[{regex:t}]},n=function(e,t){var n;t=t||null;for(var o=0;o<i.length;o++){var a=e.match(i[o].regex);if(console.log("MATCHED URL",a),a)return a.shift(),i[o].callback.apply({},match,t),!0}console.log("navigate callback: ",n),history.pushState(t,null,e),n(t)},{add:t,navigate:n}}(),t=function(t){p.$container=t,p.$container.html(u.core_html),e(),o.add(/^\/(.+)/,filevault.model.photo.newPhoto),filevault.data.initModule(),filevault.modal.initModule(f.$upload_modal),filevault.model.gallery.initModule(f.$gallery_container),filevault.model.photo.initModule(f.$photo_container),f.$global_upload_button.on("click",a),f.$acct.on("click",l),i(),$(document).on("uploadFinished",r),$(document).on("toggleModal",d),$(document).on("toggleGallery",n),$(document).on("toggleState",s),window.onpopstate=c,window.onload=c},{initModule:t}}();